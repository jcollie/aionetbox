pipeline {
  agent {
    label 'python37'
  }
  stages {
    // Clean up the workspace
    stage('Clean') {
      steps {
        container('python37-agent'){
          sh 'make clean'
        }
      }
    }

    // Lint the source code.
    stage('Test') {
      steps {
        container('python37-agent'){
          sh 'make test'
        }
      }
    }

    // Build and distribute a new package version to PyPi.
    stage('Publish to PyPi') {
      when {
        buildingTag()
      }
      environment {
        TWINE_USERNAME = 'vaporio'
        TWINE_PASSWORD = credentials('twine-password')
      }
      steps {
        // publish to pypi
        sh 'tox -e publish'
      }
    }

  }
}

